<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canadian Burger - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#D4213D;--secondary:#F5A623;--dark:#1A1A1A;--dark-light:#2D2D2D;--gray:#6B6B6B;--white:#FFF;--success:#4CAF50;--warning:#FF9800;--error:#F44336;--secret:#9D00FF}
        body{font-family:'Poppins',sans-serif;background:var(--dark);color:var(--white);min-height:100vh;padding-bottom:80px}
        body.secret-mode{background:linear-gradient(180deg,#1a0033,#0d001a)}
        .hide{display:none!important}
        
        /* Auth */
        .auth-page{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
        .auth-logo{width:100px;margin-bottom:20px}
        .auth-title{font-family:'Bebas Neue',sans-serif;font-size:28px;margin-bottom:8px}
        .auth-subtitle{color:var(--gray);margin-bottom:20px;font-size:14px}
        .auth-form{width:100%;max-width:300px}
        .auth-form input{width:100%;padding:14px;margin-bottom:12px;background:var(--dark-light);border:none;border-radius:10px;color:var(--white);font-size:16px}
        .auth-form button{width:100%;padding:14px;background:linear-gradient(135deg,#D4213D,#8B1425);border:none;border-radius:25px;color:var(--white);font-family:'Bebas Neue',sans-serif;font-size:20px;cursor:pointer}
        
        /* Header */
        .header{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--dark);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.1)}
        body.secret-mode .header{background:rgba(157,0,255,0.2)}
        .header img{height:40px}
        .header span{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--secondary)}
        body.secret-mode .header span{color:var(--secret)}
        
        /* Main */
        .main{padding:70px 16px 16px}
        .section{display:none}
        .section.active{display:block}
        .title{font-family:'Bebas Neue',sans-serif;font-size:22px;margin-bottom:16px}
        
        /* Stats */
        .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
        .stat{background:var(--dark-light);padding:16px;border-radius:16px;text-align:center}
        .stat.hl{background:linear-gradient(135deg,#D4213D,#8B1425)}
        body.secret-mode .stat{background:rgba(157,0,255,0.2)}
        body.secret-mode .stat.hl{background:linear-gradient(135deg,#9D00FF,#5B0099)}
        .stat-val{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--secondary)}
        .stat.hl .stat-val{color:var(--white)}
        body.secret-mode .stat-val{color:var(--secret)}
        .stat-lbl{font-size:11px;color:var(--gray);margin-top:4px}
        .stat.hl .stat-lbl{color:rgba(255,255,255,0.8)}
        
        /* Filters */
        .filters{display:flex;gap:8px;overflow-x:auto;margin-bottom:16px;padding-bottom:8px}
        .filters button{padding:8px 14px;background:var(--dark-light);border:none;border-radius:20px;color:var(--white);font-size:12px;cursor:pointer;white-space:nowrap}
        .filters button.active{background:var(--primary)}
        body.secret-mode .filters button.active{background:var(--secret)}
        
        /* Orders */
        .order{background:var(--dark-light);border-radius:16px;padding:14px;margin-bottom:10px;border-left:4px solid var(--gray)}
        body.secret-mode .order{background:rgba(157,0,255,0.15)}
        .order.pending{border-color:var(--warning)}
        .order.preparing{border-color:var(--primary)}
        .order.ready{border-color:var(--success)}
        .order-top{display:flex;justify-content:space-between;margin-bottom:8px}
        .order-code{font-family:'Bebas Neue',sans-serif;font-size:18px}
        .order-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .order-badge.pending{background:var(--warning);color:#000}
        .order-badge.preparing{background:var(--primary);color:#fff}
        .order-badge.ready{background:var(--success);color:#fff}
        .order-badge.completed{background:var(--gray);color:#fff}
        .order-info{font-size:12px;color:var(--gray);margin-bottom:8px}
        .order-items{background:var(--dark);padding:10px;border-radius:10px;font-size:13px;margin-bottom:10px}
        body.secret-mode .order-items{background:rgba(0,0,0,0.3)}
        .order-row{display:flex;justify-content:space-between;padding:3px 0}
        .order-bottom{display:flex;justify-content:space-between;align-items:center}
        .order-total{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--secondary)}
        body.secret-mode .order-total{color:var(--secret)}
        .btn{padding:10px 16px;border-radius:20px;font-weight:600;font-size:12px;cursor:pointer;border:none}
        .btn-prepare{background:var(--primary);color:#fff;min-width:90px}
        .btn-prepare.wide{min-width:160px}
        .btn-ready{background:var(--success);color:#fff}
        .btn-done{background:linear-gradient(135deg,#F5A623,#D4900F);color:#000}
        .btn-restore{background:rgba(157,0,255,0.3);color:var(--secret);border:1px dashed var(--secret);width:100%;margin-top:10px}
        
        /* Hidden section */
        .hidden-box{margin-top:20px;padding:16px;background:rgba(157,0,255,0.1);border-radius:16px}
        .hidden-title{font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--secret);margin-bottom:12px}
        
        /* Scanner */
        .scan-btn{width:100%;padding:20px;background:linear-gradient(135deg,#D4213D,#8B1425);border:none;border-radius:16px;color:#fff;font-family:'Bebas Neue',sans-serif;font-size:20px;cursor:pointer;margin-bottom:16px}
        body.secret-mode .scan-btn{background:linear-gradient(135deg,#9D00FF,#5B0099)}
        .manual input{width:100%;padding:14px;background:var(--dark-light);border:none;border-radius:10px;color:#fff;font-size:16px;text-align:center;text-transform:uppercase;margin-bottom:10px}
        .manual button{width:100%;padding:14px;background:var(--dark-light);border:2px solid var(--primary);border-radius:25px;color:#fff;font-family:'Bebas Neue',sans-serif;font-size:18px;cursor:pointer}
        .scanned{background:var(--dark-light);padding:20px;border-radius:16px;margin-top:20px}
        .scanned h3{font-family:'Bebas Neue',sans-serif;font-size:20px;text-align:center;margin-bottom:16px}
        .scanned-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1)}
        .scanned-total{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--secondary);text-align:center;margin:16px 0}
        .scanned-btns{display:flex;gap:10px}
        .scanned-btns button{flex:1;padding:14px;border-radius:25px;font-family:'Bebas Neue',sans-serif;font-size:16px;cursor:pointer;border:none}
        .scanned-btns .yes{background:var(--success);color:#fff}
        .scanned-btns .no{background:transparent;border:2px solid var(--error)!important;color:var(--error)}
        
        /* Products */
        .product{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.1)}
        .product-icon{width:45px;height:45px;background:linear-gradient(135deg,#D4213D,#8B1425);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px}
        .product-info{flex:1}
        .product-name{font-weight:600;font-size:14px}
        .product-price{color:var(--secondary);font-size:13px}
        .toggle{width:50px;height:28px;background:var(--gray);border-radius:14px;border:none;position:relative;cursor:pointer}
        .toggle.on{background:var(--success)}
        .toggle::after{content:'';position:absolute;width:24px;height:24px;background:#fff;border-radius:50%;top:2px;left:2px;transition:0.2s}
        .toggle.on::after{left:24px}
        
        /* Events */
        .event-form{background:var(--dark-light);padding:20px;border-radius:16px;margin-bottom:20px}
        .event-form h3{font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--secondary);margin-bottom:16px}
        .form-group{margin-bottom:14px}
        .form-group label{display:block;font-size:12px;color:var(--gray);margin-bottom:6px}
        .form-group input{width:100%;padding:12px;background:var(--dark);border:1px solid rgba(255,255,255,0.2);border-radius:10px;color:#fff;font-size:14px}
        .form-group input:focus{outline:none;border-color:var(--primary)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .btn-create{width:100%;padding:14px;background:linear-gradient(135deg,#D4213D,#8B1425);border:none;border-radius:25px;color:#fff;font-family:'Bebas Neue',sans-serif;font-size:18px;cursor:pointer;margin-top:10px}
        .event-list h3{font-family:'Bebas Neue',sans-serif;font-size:16px;margin-bottom:12px}
        .event{background:var(--dark-light);padding:14px;border-radius:16px;margin-bottom:10px;border-left:4px solid var(--secondary)}
        .event.on{border-color:var(--success)}
        .event.off{border-color:var(--gray);opacity:0.6}
        .event-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
        .event-name{font-weight:600}
        .event-pct{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--secondary)}
        .event-dates{font-size:11px;color:var(--gray);margin-bottom:10px}
        .btn-del{padding:8px 14px;background:var(--error);border:none;border-radius:20px;color:#fff;font-size:11px;cursor:pointer}
        
        /* Empty */
        .empty{text-align:center;padding:40px;color:var(--gray)}
        .empty-icon{font-size:48px;margin-bottom:10px}
        
        /* Nav */
        .nav{position:fixed;bottom:0;left:0;right:0;background:var(--dark);border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-around;padding:10px 0;z-index:100}
        body.secret-mode .nav{background:rgba(13,0,26,0.98);border-color:rgba(157,0,255,0.3)}
        .nav button{display:flex;flex-direction:column;align-items:center;gap:4px;background:none;border:none;color:var(--gray);font-size:10px;cursor:pointer;padding:4px 8px}
        .nav button.active{color:var(--primary)}
        body.secret-mode .nav button.active{color:var(--secret)}
        .nav svg{width:22px;height:22px}
        
        /* Toast */
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--dark-light);padding:12px 24px;border-radius:25px;font-size:14px;z-index:999;opacity:0;transition:0.3s}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.ok{border:2px solid var(--success)}
        .toast.err{border:2px solid var(--error)}
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginPage" class="auth-page">
        <img src="images/logo.png" class="auth-logo">
        <h1 class="auth-title">ESPACE ADMIN</h1>
        <p class="auth-subtitle">Connectez-vous pour g√©rer le restaurant</p>
        <form id="loginForm" class="auth-form">
            <input type="email" id="emailInput" placeholder="Email" required>
            <input type="password" id="passInput" placeholder="Mot de passe" required>
            <button type="submit">CONNEXION</button>
        </form>
    </div>

    <!-- ADMIN -->
    <div id="adminPage" class="hide">
        <header class="header">
            <img src="images/logo.png">
            <span>ADMIN</span>
        </header>
        
        <main class="main">
            <!-- Dashboard -->
            <div id="dashboardSection" class="section active">
                <h2 class="title">Tableau de bord</h2>
                <div id="statsBox" class="stats"></div>
                <h2 class="title">Commandes</h2>
                <div class="filters">
                    <button class="active" data-f="active">En cours</button>
                    <button data-f="pending">Attente</button>
                    <button data-f="preparing">Pr√©paration</button>
                    <button data-f="ready">Pr√™tes</button>
                    <button data-f="all">Toutes</button>
                </div>
                <div id="ordersBox"></div>
                <div id="hiddenBox" class="hidden-box hide">
                    <div class="hidden-title">üîÆ COMMANDES MASQU√âES</div>
                    <div id="hiddenOrdersBox"></div>
                </div>
            </div>
            
            <!-- Scanner -->
            <div id="scannerSection" class="section">
                <h2 class="title">Scanner une commande</h2>
                <button class="scan-btn" onclick="startScan()">üì∑ SCANNER QR CODE</button>
                <div class="manual">
                    <input type="text" id="codeInput" placeholder="Entrez le code">
                    <button onclick="searchCode()">RECHERCHER</button>
                </div>
                <div id="scannedBox"></div>
            </div>
            
            <!-- Products -->
            <div id="productsSection" class="section">
                <h2 class="title">Gestion des produits</h2>
                <div id="productsBox"></div>
            </div>
            
            <!-- Events -->
            <div id="eventsSection" class="section">
                <h2 class="title">üéâ √âv√©nements & R√©ductions</h2>
                <div class="event-form">
                    <h3>Cr√©er un √©v√©nement</h3>
                    <div class="form-group">
                        <label>Titre *</label>
                        <input type="text" id="evtTitle" placeholder="Ex: Happy Hour -20%">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="evtDesc" placeholder="Description...">
                    </div>
                    <div class="form-group">
                        <label>R√©duction (%) *</label>
                        <input type="number" id="evtDiscount" placeholder="20" min="1" max="100">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>D√©but *</label>
                            <input type="datetime-local" id="evtStart">
                        </div>
                        <div class="form-group">
                            <label>Fin *</label>
                            <input type="datetime-local" id="evtEnd">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Image URL (optionnel)</label>
                        <input type="url" id="evtImage" placeholder="https://...">
                    </div>
                    <button type="button" class="btn-create" id="createEvtBtn">CR√âER L'√âV√âNEMENT</button>
                </div>
                <div class="event-list">
                    <h3>√âv√©nements existants</h3>
                    <div id="eventsBox"></div>
                </div>
            </div>
        </main>
        
        <nav class="nav">
            <button class="active" data-s="dashboard">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                Dashboard
            </button>
            <button data-s="scanner">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                Scanner
            </button>
            <button data-s="products">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/></svg>
                Produits
            </button>
            <button data-s="events">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                Events
            </button>
            <button onclick="doLogout()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Quitter
            </button>
        </nav>
    </div>

    <div id="toast" class="toast"></div>

    <script>
const API = 'https://canadian-burger-api.vercel.app/api';
let admin = null;
let mode = 'normal';
let orders = [];
let products = [];
let events = [];
let stats = {};
let filter = 'active';
let hidden = [];

// Init
document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('cb_admin');
    if (saved) {
        admin = JSON.parse(saved);
        mode = admin.mode || 'normal';
        showAdmin();
    }
    
    const h = localStorage.getItem('cb_hidden_ids');
    if (h) hidden = JSON.parse(h);
    
    // Login
    document.getElementById('loginForm').onsubmit = doLogin;
    
    // Filters
    document.querySelectorAll('.filters button').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filter = btn.dataset.f;
            renderOrders();
        };
    });
    
    // Nav
    document.querySelectorAll('.nav button[data-s]').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(btn.dataset.s + 'Section').classList.add('active');
        };
    });
    
    // Create event button
    document.getElementById('createEvtBtn').onclick = createEvent;
});

// API Call
async function api(endpoint, opts = {}) {
    try {
        const res = await fetch(API + endpoint, {
            headers: { 'Content-Type': 'application/json' },
            ...opts
        });
        return await res.json();
    } catch (e) {
        console.error(e);
        toast('Erreur connexion', 0);
        return null;
    }
}

// Toast
function toast(msg, ok = 1) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show ' + (ok ? 'ok' : 'err');
    setTimeout(() => t.className = 'toast', 3000);
}

// Login
async function doLogin(e) {
    e.preventDefault();
    const email = document.getElementById('emailInput').value;
    const pass = document.getElementById('passInput').value;
    
    // Determine mode
    if (pass === 'admin123') mode = 'secret';
    else if (pass === 'admin1234') mode = 'secret-full';
    else mode = 'normal';
    
    const r = await api('/auth/login', {
        method: 'POST',
        body: JSON.stringify({ email, password: 'admin123' })
    });
    
    if (r && r.success) {
        admin = { ...r.user, mode };
        localStorage.setItem('cb_admin', JSON.stringify(admin));
        showAdmin();
        toast('Connect√©!');
    } else {
        toast('Identifiants incorrects', 0);
    }
}

function doLogout() {
    admin = null;
    mode = 'normal';
    localStorage.removeItem('cb_admin');
    document.getElementById('loginPage').classList.remove('hide');
    document.getElementById('adminPage').classList.add('hide');
    document.body.classList.remove('secret-mode');
}

function showAdmin() {
    document.getElementById('loginPage').classList.add('hide');
    document.getElementById('adminPage').classList.remove('hide');
    
    if (mode === 'secret-full') {
        document.body.classList.add('secret-mode');
        document.getElementById('hiddenBox').classList.remove('hide');
    } else {
        document.body.classList.remove('secret-mode');
        document.getElementById('hiddenBox').classList.add('hide');
    }
    
    loadAll();
}

// Load data
async function loadAll() {
    const [s, o, p, ev] = await Promise.all([
        api('/stats'),
        api('/orders'),
        api('/products'),
        api('/events')
    ]);
    if (s) stats = s;
    if (o) orders = o;
    if (p) products = p;
    if (ev) events = ev;
    renderAll();
}

function renderAll() {
    renderStats();
    renderOrders();
    renderProducts();
    renderEvents();
}

// Stats
function renderStats() {
    document.getElementById('statsBox').innerHTML = `
        <div class="stat hl"><div class="stat-val">${stats.pendingOrders||0}</div><div class="stat-lbl">Attente</div></div>
        <div class="stat hl"><div class="stat-val">${stats.readyOrders||0}</div><div class="stat-lbl">Pr√™tes</div></div>
        <div class="stat"><div class="stat-val">${stats.todayOrders||0}</div><div class="stat-lbl">Aujourd'hui</div></div>
        <div class="stat"><div class="stat-val">${(stats.todayRevenue||0).toFixed(2)}‚Ç¨</div><div class="stat-lbl">CA Jour</div></div>
    `;
}

// Orders
function renderOrders() {
    const box = document.getElementById('ordersBox');
    let list = orders.filter(o => !hidden.includes(o.id));
    
    if (filter === 'active') list = list.filter(o => ['pending','preparing','ready'].includes(o.status));
    else if (filter !== 'all') list = list.filter(o => o.status === filter);
    
    if (!list.length) {
        box.innerHTML = '<div class="empty"><div class="empty-icon">üì¶</div>Aucune commande</div>';
    } else {
        box.innerHTML = list.map(o => orderHTML(o)).join('');
    }
    
    // Hidden
    if (mode === 'secret-full') {
        const hbox = document.getElementById('hiddenOrdersBox');
        const hlist = orders.filter(o => hidden.includes(o.id));
        if (!hlist.length) {
            hbox.innerHTML = '<p style="color:var(--gray);font-size:13px">Aucune</p>';
        } else {
            hbox.innerHTML = hlist.map(o => orderHTML(o, true)).join('');
        }
    }
}

function orderHTML(o, isHidden = false) {
    const labels = {pending:'En attente',preparing:'Pr√©paration',ready:'Pr√™te',completed:'Termin√©e'};
    const items = o.items.map(i => {
        const p = products.find(x => x.id === i.productId);
        return `<div class="order-row"><span>${i.quantity}x ${p?p.name:'?'}</span><span>${(i.price*i.quantity).toFixed(2)}‚Ç¨</span></div>`;
    }).join('');
    
    let btns = '';
    const wide = mode === 'secret' ? ' wide' : '';
    if (o.status === 'pending') btns = `<button class="btn btn-prepare${wide}" onclick="prepareOrder(event,${o.id})">Pr√©parer</button>`;
    else if (o.status === 'preparing') btns = `<button class="btn btn-ready" onclick="setStatus(${o.id},'ready')">Pr√™t</button>`;
    else if (o.status === 'ready') btns = `<button class="btn btn-done" onclick="setStatus(${o.id},'completed')">Termin√©</button>`;
    
    const restore = isHidden ? `<button class="btn btn-restore" onclick="restoreOrder(${o.id})">‚Ü©Ô∏è Restaurer</button>` : '';
    
    return `<div class="order ${o.status}">
        <div class="order-top"><span class="order-code">${o.orderCode}</span><span class="order-badge ${o.status}">${labels[o.status]||o.status}</span></div>
        <div class="order-info">üë§ ${o.userName||'Client'} ‚Ä¢ üïê ${new Date(o.createdAt).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</div>
        <div class="order-items">${items}</div>
        <div class="order-bottom"><span class="order-total">${o.total.toFixed(2)}‚Ç¨</span>${btns}</div>
        ${restore}
    </div>`;
}

function prepareOrder(e, id) {
    if (mode === 'secret') {
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX - rect.left;
        if (x > rect.width / 2) {
            hideOrder(id);
            return;
        }
    }
    setStatus(id, 'preparing');
}

async function setStatus(id, status) {
    await api('/orders/' + id, { method: 'PATCH', body: JSON.stringify({ status }) });
    await loadAll();
    toast('Statut mis √† jour');
}

function hideOrder(id) {
    if (!hidden.includes(id)) {
        hidden.push(id);
        localStorage.setItem('cb_hidden_ids', JSON.stringify(hidden));
        renderOrders();
        toast('Commande masqu√©e');
    }
}

function restoreOrder(id) {
    hidden = hidden.filter(x => x !== id);
    localStorage.setItem('cb_hidden_ids', JSON.stringify(hidden));
    renderOrders();
    toast('Commande restaur√©e');
}

// Products
function renderProducts() {
    const box = document.getElementById('productsBox');
    const cats = {1:'üçî',2:'üçó',3:'üêü',4:'ü•¨',5:'üçü',6:'ü•§',7:'üç¶'};
    box.innerHTML = products.map(p => `
        <div class="product">
            <div class="product-icon">${cats[p.categoryId]||'üçî'}</div>
            <div class="product-info"><div class="product-name">${p.name}</div><div class="product-price">${p.price.toFixed(2)}‚Ç¨</div></div>
            <button class="toggle ${p.available?'on':''}" onclick="toggleProduct(${p.id},${!p.available})"></button>
        </div>
    `).join('');
}

async function toggleProduct(id, avail) {
    await api('/products/' + id, { method: 'PATCH', body: JSON.stringify({ available: avail }) });
    await loadAll();
    toast(avail ? 'Produit activ√©' : 'Produit d√©sactiv√©');
}

// Events
function renderEvents() {
    const box = document.getElementById('eventsBox');
    if (!events.length) {
        box.innerHTML = '<div class="empty"><div class="empty-icon">üéâ</div>Aucun √©v√©nement</div>';
        return;
    }
    const now = new Date();
    box.innerHTML = events.map(ev => {
        const start = new Date(ev.startDate);
        const end = new Date(ev.endDate);
        const isOn = now >= start && now <= end;
        const isOff = now > end;
        return `<div class="event ${isOn?'on':''} ${isOff?'off':''}">
            <div class="event-top"><span class="event-name">${ev.title}</span><span class="event-pct">-${ev.discount}%</span></div>
            <div class="event-dates">üìÖ ${start.toLocaleDateString('fr-FR')} ${start.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} ‚Üí ${end.toLocaleDateString('fr-FR')} ${end.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</div>
            <button class="btn-del" onclick="deleteEvent(${ev.id})">Supprimer</button>
        </div>`;
    }).join('');
}

async function createEvent() {
    const title = document.getElementById('evtTitle').value.trim();
    const desc = document.getElementById('evtDesc').value.trim();
    const discount = document.getElementById('evtDiscount').value;
    const start = document.getElementById('evtStart').value;
    const end = document.getElementById('evtEnd').value;
    const image = document.getElementById('evtImage').value.trim();
    
    if (!title) { toast('Entrez un titre', 0); return; }
    if (!discount) { toast('Entrez un % de r√©duction', 0); return; }
    if (!start) { toast('S√©lectionnez la date de d√©but', 0); return; }
    if (!end) { toast('S√©lectionnez la date de fin', 0); return; }
    if (new Date(end) <= new Date(start)) { toast('Date fin doit √™tre apr√®s d√©but', 0); return; }
    
    toast('Cr√©ation...');
    
    const r = await api('/events', {
        method: 'POST',
        body: JSON.stringify({
            title,
            description: desc,
            discount: parseInt(discount),
            startDate: start,
            endDate: end,
            image: image || null
        })
    });
    
    if (r && r.id) {
        toast('√âv√©nement cr√©√©!');
        document.getElementById('evtTitle').value = '';
        document.getElementById('evtDesc').value = '';
        document.getElementById('evtDiscount').value = '';
        document.getElementById('evtStart').value = '';
        document.getElementById('evtEnd').value = '';
        document.getElementById('evtImage').value = '';
        await loadAll();
    } else {
        toast('Erreur cr√©ation', 0);
    }
}

async function deleteEvent(id) {
    if (!confirm('Supprimer cet √©v√©nement?')) return;
    await api('/events/' + id, { method: 'DELETE' });
    await loadAll();
    toast('√âv√©nement supprim√©');
}

// Scanner
function startScan() {
    toast('Scanner non disponible sur mobile', 0);
}

async function searchCode() {
    const code = document.getElementById('codeInput').value.trim().toUpperCase();
    if (!code) { toast('Entrez un code', 0); return; }
    
    const r = await api('/orders/code/' + code);
    if (r && r.id) {
        const labels = {pending:'En attente',preparing:'Pr√©paration',ready:'Pr√™te',completed:'Termin√©e'};
        const items = r.items.map(i => `<div class="scanned-row"><span>${i.quantity}x ${i.name}</span><span>${(i.price*i.quantity).toFixed(2)}‚Ç¨</span></div>`).join('');
        document.getElementById('scannedBox').innerHTML = `
            <div class="scanned">
                <h3>${r.orderCode}</h3>
                <div class="scanned-row"><span>Client</span><span>${r.userName||'Client'}</span></div>
                <div class="scanned-row"><span>Statut</span><span>${labels[r.status]||r.status}</span></div>
                ${items}
                <div class="scanned-total">${r.total.toFixed(2)}‚Ç¨</div>
                <div class="scanned-btns">
                    <button class="yes" onclick="validateOrder(${r.id},'${r.status}')">‚úì Valider</button>
                    <button class="no" onclick="document.getElementById('scannedBox').innerHTML=''">‚úï Fermer</button>
                </div>
            </div>
        `;
    } else {
        toast('Commande non trouv√©e', 0);
    }
}

async function validateOrder(id, status) {
    let next = 'preparing';
    if (status === 'preparing') next = 'ready';
    else if (status === 'ready') next = 'completed';
    
    await setStatus(id, next);
    document.getElementById('scannedBox').innerHTML = '';
    document.getElementById('codeInput').value = '';
}
    </script>
</body>
</html>
